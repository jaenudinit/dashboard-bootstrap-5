<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WMS Mitra10 Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
    <link rel="stylesheet" href="css/style.css" />
</head>

<body>
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="D:/Project/Dashboard/index.html" class="d-flex align-items-center text-white text-decoration-none">
                <img src="img/Logo.png" alt="Logo" />
                <span>WMS Mitra10</span>
            </a>
        </div>

        <ul class="nav flex-column mt-3">
            <li class="nav-item">
                <a class="nav-link active" href="#"><i class="bi bi-speedometer2"></i><span>Dashboard</span></a>
            </li>

            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="collapse" href="#menuMaster" role="button" aria-expanded="true">
                    <i class="bi bi-folder"></i><span>MASTER</span>
                    <i class="bi bi-chevron-down float-end"></i>
                </a>
                <div class="collapse show" id="menuMaster">
                    <ul class="nav flex-column ms-3">
                        <li><a class="nav-link" href="D:/Project/Dashboard/index2.html"><i
                                    class="bi bi-map"></i><span>Area</span></a></li>
                        <li><a class="nav-link" href="#"><i class="bi bi-geo-alt"></i><span>Location</span></a></li>
                        <li><a class="nav-link" href="#"><i class="bi bi-diagram-3"></i><span>Zone</span></a></li>
                        <li><a class="nav-link" href="#"><i class="bi bi-box"></i><span>Storage Location</span></a></li>
                        <li><a class="nav-link" href="#"><i class="bi bi-list-check"></i><span>Storage Location
                                    Attribute List</span></a></li>
                        <li><a class="nav-link" href="#"><i class="bi bi-person-vcard"></i><span>Storage Location
                                    Profile</span></a></li>
                    </ul>
                </div>
            </li>

            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="collapse" href="#menuTransaction" role="button"
                    aria-expanded="true">
                    <i class="bi bi-folder"></i><span>TRANSACTION</span>
                    <i class="bi bi-chevron-down float-end"></i>
                </a>
                <div class="collapse show" id="menuTransaction">
                    <ul class="nav flex-column ms-3">
                        <li><a class="nav-link" href="D:/Project/Dashboard/index3.html"><i
                                    class="bi bi-play"></i><span>Execution</span></a></li>
                        <li><a class="nav-link" href="D:/Project/Dashboard/index4.html"><i
                                    class="bi bi-play"></i><span>Execution Process</span></a></li>
                        <li><a class="nav-link" href="#"><i class="bi bi-geo-alt"></i><span>Location</span></a></li>
                        <li><a class="nav-link" href="#"><i class="bi bi-diagram-3"></i><span>Zone</span></a></li>
                        <li><a class="nav-link" href="#"><i class="bi bi-box"></i><span>Storage Location</span></a></li>
                        <li><a class="nav-link" href="#"><i class="bi bi-list-check"></i><span>Storage Location
                                    Attribute List</span></a></li>
                        <li><a class="nav-link" href="#"><i class="bi bi-person-vcard"></i><span>Storage Location
                                    Profile</span></a></li>
                    </ul>
                </div>
            </li>

            <li class="nav-item">
                <a class="nav-link" href="#"><i class="bi bi-gear"></i><span>Settings</span></a>
            </li>
        </ul>
    </aside>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <nav class="navbar navbar-expand-lg">
            <div class="container-fluid">
                <button class="btn me-3" id="toggleSidebar">
                    <i class="bi bi-list"></i>
                </button>
                <a class="navbar-brand" href="#">10003 - MITRA10 CIBUBUR</a>

                <!-- User Info -->
                <div class="ms-auto user-info dropdown">
                    <i class="bi bi-arrows-fullscreen" title="Fullscreen" id="btnFullscreen"></i>
                    <span id="userName">jaenudin</span>
                    <a href="#" class="text-white" id="dropdownMenuButton" data-bs-toggle="dropdown"
                        aria-expanded="false">
                        <i class="bi bi-gear" title="Settings"></i>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end shadow" aria-labelledby="dropdownMenuButton">
                        <li>
                            <a class="dropdown-item" href="#"><i class="bi bi-geo"></i> Change Location</a>
                        </li>
                        <li>
                            <hr class="dropdown-divider" />
                        </li>
                        <li>
                            <a class="dropdown-item text-danger" href="D:/Project/Dashboard/Login.html"><i
                                    class="bi bi-box-arrow-right"></i> Log
                                Out</a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="container-fluid mt-2">
            <!-- Content -->
            <h6 class="section-title mb-2 fw-bold">Execution Process</h6>

            <div class="card py-2 px-2 card-fixed-hover mb-2">
                <!-- Tombol dan Form Multi-Search -->
                <p class="fw-bold mb-1">TASK : <span class="text-primary">PC-10011-2501-0000000001</span></p>
                <p class="fw-bold mb-2">From SLoc : <span class="text-primary">SL00000013</span></p>

                <!-- Description Card -->
                <div class="card border-primary mb-3 position-relative" id="descContainer">
                    <div class="card-header text-dark d-flex justify-content-between align-items-center py-1">
                        <span class="fw-bold">Description</span>
                        <div>
                            <!-- Collapse Button -->
                            <button type="button" class="btn btn-sm me-1 fs-6 toggle-collapse" data-bs-toggle="collapse"
                                data-bs-target="#descCard" aria-expanded="true">
                                <i class="bi bi-arrows-collapse"></i>
                            </button>
                            <!-- Expand Button -->
                            <button type="button" class="btn btn-sm btn-light toggle-expand">
                                <i class="bi bi-arrows-angle-expand"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Collapsible Body -->
                    <div class="collapse show" id="descCard">
                        <div class="card-body p-2">
                            <table class="table table-borderless table-striped table-sm mb-0">
                                <tbody>
                                    <tr>
                                        <td width="35%">Item No</td>
                                        <td width="5%">:</td>
                                        <td></td>
                                    </tr>
                                    <tr>
                                        <td>Item Description</td>
                                        <td>:</td>
                                        <td></td>
                                    </tr>
                                    <tr>
                                        <td>Barcode No</td>
                                        <td>:</td>
                                        <td></td>
                                    </tr>
                                    <tr>
                                        <td>Base UOM</td>
                                        <td>:</td>
                                        <td></td>
                                    </tr>
                                    <tr>
                                        <td>Transaction UOM</td>
                                        <td>:</td>
                                        <td></td>
                                    </tr>
                                    <tr>
                                        <td>Lot No</td>
                                        <td>:</td>
                                        <td></td>
                                    </tr>
                                    <tr>
                                        <td>Order Qty</td>
                                        <td>:</td>
                                        <td class="text-primary fw-bold"></td>
                                    </tr>
                                    <tr>
                                        <td>To Be Pick Qty</td>
                                        <td>:</td>
                                        <td></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Lot Description -->
                <div class="card border-primary mb-3 position-relative" id="lotContainer">
                    <div class="card-header text-dark d-flex justify-content-between align-items-center py-1">
                        <span class="fw-bold">Lot Description</span>
                        <div>
                            <!-- Collapse Button -->
                            <button type="button" class="btn btn-sm me-1 fs-6 toggle-collapse collapsed"
                                data-bs-toggle="collapse" data-bs-target="#lotCard" aria-expanded="true">
                                <i class="bi bi-arrows-expand"></i>
                            </button>
                            <!-- Expand Button -->
                            <button type="button" class="btn btn-sm btn-light toggle-expand">
                                <i class="bi bi-arrows-angle-expand"></i>
                            </button>
                        </div>
                    </div>
                    <div class="collapse" id="lotCard">
                        <div class="card-body p-2">
                            <table class="table table-borderless table-striped table-sm mb-0">
                                <tbody>
                                    <tr>
                                        <td width="35%">Batch No</td>
                                        <td width="5%">:</td>
                                        <td></td>
                                    </tr>
                                    <tr>
                                        <td>Expired Date</td>
                                        <td>:</td>
                                        <td></td>
                                    </tr>
                                    <tr>
                                        <td>Production Date</td>
                                        <td>:</td>
                                        <td></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Input Section -->
                <div class="card border-primary">
                    <div class="card-header text-dark d-flex justify-content-between align-items-center py-1">
                        <span class="fw-bold">Use MHE : <span class="text-primary">MHE001</span></span>
                        <div>
                            <!-- Collapse Button -->
                            <button type="button" class="btn btn-sm me-1 fs-6 toggle-collapse" data-bs-toggle="collapse"
                                data-bs-target="#ExecutionCard" aria-expanded="true">
                                <i class="bi bi-arrows-collapse"></i>
                            </button>
                            <!-- Expand Button -->
                            <button type="button" class="btn btn-sm btn-light toggle-expand">
                                <i class="bi bi-arrows-angle-expand"></i>
                            </button>
                        </div>
                    </div>
                    <div class="collapse show" id="ExecutionCard">
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label mb-0">Item / Barcode No</label>
                                        <div class="input-group input-group-sm">
                                            <input type="text" class="form-control" />
                                            <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal"
                                                data-bs-target="#modal-choose-item">Choose</button>
                                            <button type="button" class="btn btn-sm btn-warning ms-1"
                                                data-bs-toggle="modal" data-bs-target="#qrScannerModal">
                                                <i class="bi bi-qr-code-scan"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label mb-0">Lot No</label>
                                        <select class="form-select form-select-sm" id="LotNo">
                                            <option value="" selected disabled>Select Lot No</option>
                                        </select>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label mb-0">Pick Quantity</label>
                                        <div class="input-group input-group-sm">
                                            <input type="text" class="form-control form-control-sm text-end"
                                                value="0" />
                                            <span class="input-group-text bg-info py-0">BOX</span>
                                            <!-- <span class="ms-1 text-center">Already Pick <br> 20</span> -->
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="row g-2 mb-3">
                                        <div class="col-md-4">
                                            <label class="form-label mb-0">Reason</label>
                                            <select id="ReasonId" class="form-select form-select-sm">
                                                <option value="" selected disabled>Select Reason</option>
                                            </select>
                                        </div>
                                        <div class="col-md-8">
                                            <label class="form-label mb-0">Description</label>
                                            <input type="text" class="form-control form-control-sm" />
                                        </div>
                                    </div>

                                    <div>
                                        <label class="form-label mb-0">Outstanding Qty</label>
                                        <input type="text" class="form-control form-control-sm text-end" value="0"
                                            readonly />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-flex justify-content-end px-3">
                        <button class="btn btn-success btn-sm me-2">Save</button>
                        <button class="btn btn-secondary btn-sm">Cancel</button>
                    </div>

                    <!-- Pagination -->
                    <div class="row m-3">
                        <div class="col-md-12 d-flex justify-content-around align-items-center">
                            <button class="btn btn-sm btn-primary" disabled><i class="bi bi-arrow-left-short"></i>
                                Previous</button>
                            <span class="fs-7 fw-normal" style="color:dimgrey">Page 1 of 5</span>
                            <button class="btn btn-sm btn-primary" disabled>Next <i
                                    class="bi bi-arrow-right-short"></i></button>
                        </div>
                    </div>
                </div>

                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 d-flex justify-content-center justify-content-lg-start mt-2">
                            <button class="btn btn-sm btn-secondary d-inline">Back To List</button>
                            <button class="btn btn-sm btn-warning d-inline text-center ms-2"
                                style="white-space: normal;" disabled>
                                Next Location
                            </button>
                        </div>
                        <div class="col-md-6 d-flex justify-content-center justify-content-lg-end mt-2">
                            <button class="btn btn-sm btn-primary d-inline"
                                style="white-space: normal; word-wrap: break-word; text-align: center;">
                                View Outstanding
                            </button>
                            <button class="btn btn-sm btn-success d-inline ms-2" disabled>
                                Put Item
                            </button>
                        </div>
                    </div>
                </div>

            </div>

        </div>

        <!-- QR Scanner Modal -->
        <div class="modal fade" id="qrScannerModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h6><i class="bi bi-qr-code-scan me-1"></i> Scan QR Code</h6>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center">
                        <div id="reader" style="width:100%; max-width:480px; margin:auto;"></div>
                        <div id="cameraSelectContainer" class="mt-2"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- QR Scanner Modal -->
        <div class="modal fade" id="modal-choose-item" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h6>Choose Item</h6>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body p-2 pb-4">
                        <!-- Search Bar -->
                        <div class="input-group input-group-sm mt-2 mb-3">
                            <select class="form-select">
                                <option value="ItemNo">Item No</option>
                            </select>
                            <input type="text" class="form-control" placeholder="Search..." />
                            <button class="btn btn-outline-secondary" type="button">
                                <i class="bi bi-search"></i> Search
                            </button>
                        </div>

                        <!-- Data Items Section -->
                        <div class="table-section">
                            <!-- Show Entries -->
                            <div class="d-flex align-items-center mb-2">
                                <span class="me-2">Show</span>
                                <select class="form-select form-select-sm me-2 w-auto form-select-show-entries">
                                    <option value="25">25</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                </select>
                                <span>entries</span>
                            </div>

                            <!-- Table -->
                            <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                <table
                                    class="table table-bordered table-striped table-hover align-middle text-wrap mb-0">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th style="cursor:pointer; width:100px;">
                                                <div class="d-flex justify-content-around align-items-center">
                                                    <span>Action</span>
                                                </div>
                                            </th>
                                            <th style="cursor:pointer;">
                                                <div class="d-flex justify-content-around align-items-center">
                                                    <span>Item No</span>
                                                    <i class="bi bi-sort-alpha-down"></i>
                                                </div>
                                            </th>
                                            <th style="cursor:pointer;">
                                                <div class="d-flex justify-content-around align-items-center">
                                                    <span>Item Name</span>
                                                    <i class="bi bi-sort-alpha-down"></i>
                                                </div>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td class="text-center">
                                                <button class="btn btn-sm btn-primary">Select</button>
                                            </td>
                                            <td>ITEM001</td>
                                            <td>Item Description 1</td>
                                        </tr>
                                        <tr>
                                            <td class="text-center">
                                                <button class="btn btn-sm btn-primary">Select</button>
                                            </td>
                                            <td>ITEM002</td>
                                            <td>Item Description 2</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Pagination -->
                            <div class="d-flex justify-content-between align-items-center mt-2">
                                <small>Showing 1 to 2 of 2 entries</small>
                                <nav>
                                    <ul class="pagination pagination-sm mb-0">
                                        <li class="page-item disabled">
                                            <a class="page-link">Previous</a>
                                        </li>
                                        <li class="page-item active">
                                            <a class="page-link" href="#">1</a>
                                        </li>
                                        <li class="page-item disabled">
                                            <a class="page-link">Next</a>
                                        </li>
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer mt-auto py-2">
            <div class="d-flex justify-content-between px-4">
                <span>© WMS Mitra10</span>
                <span class="text-primary">v1.0.0</span>
            </div>
        </footer>
    </div>

    <!-- JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <script src="js/script.js"></script>
    <script>
        (function() {
            let html5QrCode = null;
            let currentCameraIdOrConfig = null;
            const modalEl = document.getElementById("qrScannerModal");
            const readerId = "reader";

            // Utility: try to cleanly stop and clear previous instance
            async function stopScannerInstance() {
                if (html5QrCode) {
                    try {
                        await html5QrCode.stop();
                    } catch (err) {
                        // ignore stop errors but log
                        console.warn("Error stopping previous scanner:", err);
                    }
                    try {
                        html5QrCode.clear();
                    } catch (err) {
                        // ignore clear errors
                    }
                    html5QrCode = null;
                }
            }

            // Start scanner with a camera id or fallback config
            async function startScannerWith(cameraIdOrConfig) {
                await stopScannerInstance();
                html5QrCode = new Html5Qrcode(readerId);

                try {
                    await html5QrCode.start(
                        cameraIdOrConfig, {
                            fps: 10,
                            qrbox: {
                                width: 250,
                                height: 250
                            }
                        },
                        (decodedText, decodedResult) => {
                            // On success: place value to input (if any) and close modal
                            console.log("QR code:", decodedText);
                            const input = document.getElementById("barcodeInput");
                            if (input) input.value = decodedText;

                            // close modal
                            const bsModal = bootstrap.Modal.getInstance(modalEl);
                            if (bsModal) bsModal.hide();
                        },
                        (error) => {
                            // parse errors silently or display if you prefer
                            //console.debug("scan error:", error);
                        }
                    );
                    currentCameraIdOrConfig = cameraIdOrConfig;
                    console.log("Scanner started with:", cameraIdOrConfig);
                } catch (startErr) {
                    console.error("Failed to start scanner with", cameraIdOrConfig, startErr);
                    // if failed and we passed a string id, try fallback to facingMode
                    if (typeof cameraIdOrConfig === "string" || cameraIdOrConfig?.deviceId) {
                        try {
                            console.log("Retrying with facingMode fallback...");
                            await startScannerWith({
                                facingMode: "environment"
                            });
                        } catch (e) {
                            console.error("Retry also failed:", e);
                        }
                    }
                }
            }

            // When modal is shown -> enumerate cameras and start scanner
            modalEl.addEventListener("shown.bs.modal", async () => {
                try {
                    // ensure element exists
                    if (!document.getElementById(readerId)) {
                        console.error("Reader element not found:", readerId);
                        return;
                    }

                    // enumerate cameras (might prompt permission in some browsers)
                    let devices = [];
                    try {
                        devices = await Html5Qrcode.getCameras(); // returns array or throws
                    } catch (enumErr) {
                        console.warn("getCameras() failed or not supported:", enumErr);
                        devices = [];
                    }

                    // build optional camera select UI if multiple cameras
                    const cameraSelectContainer = document.getElementById("cameraSelectContainer");
                    cameraSelectContainer.innerHTML = ""; // clear
                    if (devices && devices.length > 1) {
                        const select = document.createElement("select");
                        select.className = "form-select form-select-sm w-50 mx-auto";
                        devices.forEach((d, i) => {
                            const id = d.id || d.deviceId || d.label || `camera-${i}`;
                            const label = d.label || `Camera ${i + 1}`;
                            const opt = document.createElement("option");
                            opt.value = id;
                            opt.text = label;
                            select.appendChild(opt);
                        });
                        // on change restart with chosen camera
                        select.addEventListener("change", async (ev) => {
                            const val = ev.target.value;
                            // if we used label-only fallback, try using facingMode
                            await startScannerWith(val || {
                                facingMode: "environment"
                            });
                        });
                        cameraSelectContainer.appendChild(select);
                    }

                    // choose a camera id if available
                    let chosen = null;
                    if (devices && devices.length > 0) {
                        // prefer device.id or device.deviceId if available
                        const first = devices[0];
                        chosen = first.id || first.deviceId || null;
                    }

                    // If no chosen camera id, fallback to facingMode config (works in many browsers)
                    if (chosen) {
                        await startScannerWith(chosen);
                    } else {
                        await startScannerWith({
                            facingMode: "environment"
                        });
                    }
                } catch (err) {
                    console.error("Error starting scanner on modal shown:", err);
                }
            });

            // When modal hidden -> stop scanner
            modalEl.addEventListener("hidden.bs.modal", async () => {
                try {
                    await stopScannerInstance();
                } catch (err) {
                    console.warn("Error stopping scanner on modal hide:", err);
                }
                const container = document.getElementById("cameraSelectContainer");
                if (container) container.innerHTML = "";
            });

            // If user clicks outer close button we also stop (redundant but safe)
            // Note: add onclick="stopScanner()" to close button if you want direct call

        })();
    </script>

</body>

</html>
